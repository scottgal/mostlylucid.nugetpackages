@page "/bot-test"
@model Mostlylucid.BotDetection.Demo.Pages.BotTestModel
@{
    ViewData["Title"] = "Bot Detection Test";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Mostlylucid.BotDetection</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <!-- highlight.js for JSON syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            background: #0d1117;
            color: #c9d1d9;
        }
        h1 { color: #58a6ff; margin-bottom: 5px; }
        .subtitle { color: #8b949e; margin-bottom: 25px; }
        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .card h2 { margin-top: 0; color: #c9d1d9; font-size: 1.1em; border-bottom: 1px solid #30363d; padding-bottom: 10px; }

        /* Test Buttons */
        .test-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .test-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.2s;
        }
        .test-btn:hover { transform: translateY(-1px); }
        .test-btn.human { background: #238636; color: white; }
        .test-btn.search { background: #1f6feb; color: white; }
        .test-btn.scraper { background: #f0883e; color: white; }
        .test-btn.malicious { background: #da3633; color: white; }
        .test-btn.ai { background: #8957e5; color: white; }
        .test-btn.social { background: #3fb950; color: white; }
        .test-btn.monitor { background: #388bfd; color: white; }
        .test-btn.active { box-shadow: 0 0 0 2px #58a6ff; }

        /* Path Toggle */
        .path-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 12px;
            background: #21262d;
            border-radius: 6px;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        .toggle-switch input { display: none; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: #30363d;
            border-radius: 13px;
            transition: 0.3s;
        }
        .toggle-slider:before {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        .toggle-switch input:checked + .toggle-slider { background: #238636; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
        .path-label { font-size: 0.9em; }
        .path-label.active { color: #58a6ff; font-weight: 600; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box {
            background: #21262d;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value { font-size: 1.8em; font-weight: bold; color: #58a6ff; }
        .stat-label { font-size: 0.8em; color: #8b949e; margin-top: 5px; }

        /* Detection Result */
        .result-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .result-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        .result-badge.human { background: #238636; color: white; }
        .result-badge.bot { background: #da3633; color: white; }
        .result-badge.suspicious { background: #f0883e; color: white; }
        .confidence-score {
            font-size: 2em;
            font-weight: bold;
        }
        .confidence-score.low { color: #3fb950; }
        .confidence-score.medium { color: #f0883e; }
        .confidence-score.high { color: #da3633; }

        /* Risk Band & Action */
        .risk-action { display: flex; gap: 20px; margin: 15px 0; }
        .risk-item { flex: 1; }
        .risk-label { font-size: 0.8em; color: #8b949e; margin-bottom: 5px; }
        .risk-value { font-weight: 600; padding: 4px 10px; border-radius: 4px; display: inline-block; }
        .risk-value.low { background: #238636; color: white; }
        .risk-value.medium { background: #f0883e; color: white; }
        .risk-value.high { background: #da3633; color: white; }
        .risk-value.critical { background: #8957e5; color: white; }
        .action-value { font-weight: 600; color: #c9d1d9; }

        /* Detectors */
        .detector-tags { display: flex; flex-wrap: wrap; gap: 6px; margin: 15px 0; }
        .detector-tag {
            padding: 4px 10px;
            background: #30363d;
            border-radius: 12px;
            font-size: 0.8em;
            color: #8b949e;
        }
        .detector-tag.active { background: #1f6feb; color: white; }

        /* Signals List */
        .signals-list { margin-top: 15px; }
        .signal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #21262d;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 0.9em;
        }
        .signal-category {
            font-weight: 600;
            color: #58a6ff;
            min-width: 120px;
        }
        .signal-detail { flex: 1; color: #c9d1d9; margin: 0 15px; }
        .signal-impact {
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .signal-impact.high { background: #da3633; color: white; }
        .signal-impact.medium { background: #f0883e; color: white; }
        .signal-impact.low { background: #f0883e33; color: #f0883e; }
        .signal-impact.human { background: #238636; color: white; }
        .signal-impact.neutral { background: #30363d; color: #8b949e; }

        /* Category Scores */
        .category-scores { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .category-item {
            background: #21262d;
            padding: 10px;
            border-radius: 6px;
        }
        .category-name { font-size: 0.8em; color: #8b949e; }
        .category-bar {
            height: 6px;
            background: #30363d;
            border-radius: 3px;
            margin-top: 6px;
            overflow: hidden;
        }
        .category-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        .category-fill.low { background: #3fb950; }
        .category-fill.medium { background: #f0883e; }
        .category-fill.high { background: #da3633; }

        /* Client Detection */
        .client-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .fingerprint-data {
            font-family: 'Cascadia Code', 'Fira Code', monospace;
            font-size: 0.8em;
            background: #0d1117;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #30363d;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
        }
        /* Override highlight.js background for consistency */
        .fingerprint-data pre { margin: 0; background: transparent !important; }
        .fingerprint-data code { background: transparent !important; }
        .hljs { background: transparent !important; }

        /* Loading indicator */
        .htmx-request .htmx-indicator { display: inline-block; }
        .htmx-indicator { display: none; margin-left: 8px; }

        @@media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .client-grid { grid-template-columns: 1fr; }
            .category-scores { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <h1>Bot Detection Showroom</h1>
    <p class="subtitle">Full detection pipeline demonstration - all slow path detectors enabled</p>

    <!-- Test Buttons -->
    <div class="card">
        <h2>Simulate Bot Types</h2>
        <p style="font-size: 0.85em; color: #8b949e; margin-bottom: 15px;">Click to test detection with different bot signatures</p>
        <div style="background: #21262d; border-left: 3px solid #f0883e; padding: 12px 15px; margin-bottom: 15px; border-radius: 0 6px 6px 0;">
            <strong style="color: #f0883e;">Demo Note:</strong>
            <span style="color: #8b949e; font-size: 0.85em;">
                These buttons simulate bot User-Agent strings only. Your real browser's fingerprint, headers, and behavioral
                patterns remain legitimate, so detection may still classify you as human &mdash; for example, "Malicious Bot"
                may return as human with the LLM noting: <em style="color: #c9d1d9;">"missing Accept-Language/Referer, datacenter IP detected,
                and weak evidence suggests possible bot activity. Further investigation needed."</em>
                Check the <strong style="color: #c9d1d9;">Raw API Response</strong> below for full detector reasoning.
                In production, actual bots exhibit consistent bot signals across all detectors.
            </span>
        </div>
        <div class="test-buttons">
            <button class="test-btn human"
                    hx-get="/bot-test"
                    hx-headers='{"ml-bot-test-mode": "human", "X-Bot-Policy": "demo"}'
                    hx-target="body"
                    hx-swap="outerHTML">Real Browser</button>
            <button class="test-btn search"
                    hx-get="/bot-test"
                    hx-headers='{"ml-bot-test-mode": "googlebot", "X-Bot-Policy": "demo"}'
                    hx-target="body"
                    hx-swap="outerHTML">Googlebot</button>
            <button class="test-btn search"
                    hx-get="/bot-test"
                    hx-headers='{"ml-bot-test-mode": "bingbot", "X-Bot-Policy": "demo"}'
                    hx-target="body"
                    hx-swap="outerHTML">Bingbot</button>
            <button class="test-btn scraper"
                    hx-get="/bot-test"
                    hx-headers='{"ml-bot-test-mode": "scrapy", "X-Bot-Policy": "demo"}'
                    hx-target="body"
                    hx-swap="outerHTML">Scrapy</button>
            <button class="test-btn scraper"
                    hx-get="/bot-test"
                    hx-headers='{"ml-bot-test-mode": "curl", "X-Bot-Policy": "demo"}'
                    hx-target="body"
                    hx-swap="outerHTML">cURL</button>
            <button class="test-btn scraper"
                    hx-get="/bot-test"
                    hx-headers='{"ml-bot-test-mode": "puppeteer", "X-Bot-Policy": "demo"}'
                    hx-target="body"
                    hx-swap="outerHTML">Puppeteer</button>
            <button class="test-btn malicious"
                    hx-get="/bot-test"
                    hx-headers='{"ml-bot-test-mode": "malicious", "X-Bot-Policy": "demo"}'
                    hx-target="body"
                    hx-swap="outerHTML">Malicious Bot</button>
            <button class="test-btn ai"
                    hx-get="/bot-test"
                    hx-headers='{"ml-bot-test-mode": "gptbot", "X-Bot-Policy": "demo"}'
                    hx-target="body"
                    hx-swap="outerHTML">GPTBot</button>
            <button class="test-btn ai"
                    hx-get="/bot-test"
                    hx-headers='{"ml-bot-test-mode": "claudebot", "X-Bot-Policy": "demo"}'
                    hx-target="body"
                    hx-swap="outerHTML">ClaudeBot</button>
            <button class="test-btn social"
                    hx-get="/bot-test"
                    hx-headers='{"ml-bot-test-mode": "twitterbot", "X-Bot-Policy": "demo"}'
                    hx-target="body"
                    hx-swap="outerHTML">TwitterBot</button>
            <button class="test-btn social"
                    hx-get="/bot-test"
                    hx-headers='{"ml-bot-test-mode": "facebookbot", "X-Bot-Policy": "demo"}'
                    hx-target="body"
                    hx-swap="outerHTML">FacebookBot</button>
            <button class="test-btn monitor"
                    hx-get="/bot-test"
                    hx-headers='{"ml-bot-test-mode": "uptimerobot", "X-Bot-Policy": "demo"}'
                    hx-target="body"
                    hx-swap="outerHTML">UptimeRobot</button>
        </div>

        <!-- Path Toggle -->
        <div class="path-toggle">
            <span class="path-label" id="fastLabel">Fast Path (all static detectors + bailout)</span>
            <label class="toggle-switch">
                <input type="checkbox" id="pathToggle" checked onchange="togglePath(true)">
                <span class="toggle-slider"></span>
            </label>
            <span class="path-label active" id="slowLabel">Demo (full pipeline + AI)</span>
            <span style="margin-left: auto; font-size: 0.8em; color: #8b949e;">
                Processing: <strong id="timingDisplay">@Model.ProcessingTimeMs.ToString("F2")ms</strong>
            </span>
        </div>
    </div>

    <!-- Pipeline Stats -->
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-value">@Model.DetectorCount</div>
            <div class="stat-label">Detectors Ran</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">@Model.Reasons.Count</div>
            <div class="stat-label">Signals Found</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">@Model.CategoryScores.Count</div>
            <div class="stat-label">Categories</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">@Model.ProcessingTimeMs.ToString("F1")ms</div>
            <div class="stat-label">Processing Time</div>
        </div>
    </div>

    <!-- Detection Result -->
    <div class="card">
        <h2>Detection Result</h2>
        @{
            // Show the relevant probability: human probability for humans, bot probability for bots
            var displayProbability = Model.IsBot ? Model.BotProbability : Model.HumanProbability;
            var probabilityLabel = Model.IsBot ? "bot probability" : "human probability";
            // For coloring: high confidence in classification is good (green), low is uncertain (orange)
            var colorClass = displayProbability > 0.7 ? "low" : displayProbability > 0.5 ? "medium" : "high";
        }
        <div class="result-header">
            <span class="result-badge @(Model.IsBot ? (Model.BotProbability > 0.7 ? "bot" : "suspicious") : "human")">
                @(Model.IsBot ? (Model.BotProbability > 0.7 ? "Bot Detected" : "Suspicious") : "Human")
            </span>
            <span class="confidence-score @colorClass">
                @displayProbability.ToString("P0")
            </span>
            <span style="color: #8b949e; font-size: 0.9em;">@probabilityLabel</span>
        </div>

        <div class="risk-action">
            <div class="risk-item">
                <div class="risk-label">Risk Band</div>
                <span class="risk-value @Model.RiskBand.ToLower()">@Model.RiskBand</span>
            </div>
            <div class="risk-item">
                <div class="risk-label">Recommended Action</div>
                <span class="action-value">@Model.RecommendedAction</span>
            </div>
            <div class="risk-item">
                <div class="risk-label">Bot Type</div>
                <span class="action-value">@Model.BotType</span>
            </div>
            <div class="risk-item">
                <div class="risk-label">Bot Name</div>
                <span class="action-value">@Model.BotName</span>
            </div>
        </div>

        <!-- AI Explanation -->
        @if (!string.IsNullOrEmpty(Model.AiExplanation))
        {
            var isLlm = Model.AiExplanationSource == "LLM";
            var accentColor = isLlm ? "#8957e5" : "#388bfd";
            var label = isLlm ? "LLM Analysis" : "Heuristic Analysis";
            <div style="margin-top: 20px; background: #21262d; border-left: 3px solid @accentColor; padding: 12px 15px; border-radius: 0 6px 6px 0;">
                <div style="font-size: 0.8em; color: @accentColor; font-weight: 600; margin-bottom: 6px;">
                    <span style="margin-right: 6px;">@(isLlm ? "ðŸ¤–" : "ðŸ“Š")</span>@label
                </div>
                <div style="color: #c9d1d9; font-size: 0.9em; line-height: 1.5;">@Model.AiExplanation</div>
            </div>
        }

        <!-- Active Detectors -->
        <div style="margin-top: 20px;">
            <div style="font-size: 0.85em; color: #8b949e; margin-bottom: 8px;">Active Detectors</div>
            <div class="detector-tags">
                @foreach (var detector in Model.DetectorsRan)
                {
                    <span class="detector-tag active">@detector</span>
                }
                @if (!Model.DetectorsRan.Any())
                {
                    <span class="detector-tag">No detectors reported</span>
                }
            </div>
        </div>
    </div>

    <!-- Detection Signals -->
    @if (Model.Reasons.Any())
    {
        <div class="card">
            <h2>Detection Signals (@Model.Reasons.Count)</h2>
            <div class="signals-list">
                @foreach (var reason in Model.Reasons.OrderByDescending(r => Math.Abs(r.Impact)))
                {
                    <div class="signal-item">
                        <span class="signal-category">@reason.Category</span>
                        <span class="signal-detail">@reason.Detail</span>
                        <span class="signal-impact @reason.ImpactClass">@reason.ImpactDisplay</span>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Category Scores -->
    @if (Model.CategoryScores.Any())
    {
        <div class="card">
            <h2>Category Breakdown</h2>
            <div class="category-scores">
                @foreach (var cat in Model.CategoryScores.OrderByDescending(c => c.Value))
                {
                    var pct = cat.Value * 100;
                    var level = pct < 30 ? "low" : pct < 60 ? "medium" : "high";
                    <div class="category-item">
                        <div class="category-name">@cat.Key: @cat.Value.ToString("P0")</div>
                        <div class="category-bar">
                            <div class="category-fill @level" style="width: @pct%"></div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Client-Side Detection -->
    <div class="card">
        <h2>Client-Side Detection</h2>
        <div class="client-grid">
            <div>
                <div style="margin-bottom: 15px;">
                    <div class="result-header">
                        <span class="result-badge human" id="clientBadge">Collecting...</span>
                        <span class="confidence-score" id="clientScore">--</span>
                        <span style="color: #8b949e; font-size: 0.9em;">integrity</span>
                    </div>
                </div>
                <div id="clientDetails" style="font-size: 0.9em; color: #8b949e;"></div>
            </div>
            <div>
                <div style="font-size: 0.85em; color: #8b949e; margin-bottom: 8px;">Fingerprint Data</div>
                <div class="fingerprint-data" id="fingerprintData">Waiting for fingerprint collection...</div>
            </div>
        </div>
    </div>

    <!-- API Response -->
    <div class="card">
        <h2>Raw API Response</h2>
        <button class="test-btn search" onclick="fetchDetectionCheck()">Refresh Detection</button>
        <div class="fingerprint-data" id="apiResponse" style="margin-top: 15px;">Click button to fetch...</div>
    </div>

    <!-- Bot Detection Script - fingerprint collection -->
    <!-- Note: Fingerprint endpoint uses path mapping to demo policy for consistent collection -->
    <bot-detection-script endpoint="/bot-detection/fingerprint" />

    <script>
        // ==========================================
        // Helper functions (must be defined first)
        // ==========================================

        // Helper to escape HTML for safe display
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper to render JSON with syntax highlighting
        function renderHighlightedJson(element, data) {
            var json = JSON.stringify(data, null, 2);
            element.innerHTML = '<pre><code class="language-json">' + escapeHtml(json) + '</code></pre>';
            hljs.highlightElement(element.querySelector('code'));
        }

        // ==========================================
        // Path toggle functionality
        // ==========================================

        // Path toggle functionality with localStorage persistence
        // Demo (slow) = full pipeline + AI, FastPath = all static detectors + bailout
        function togglePath(triggerRefresh) {
            var isDemoPath = document.getElementById('pathToggle').checked;

            // Persist to localStorage
            localStorage.setItem('botDetectionPath', isDemoPath ? 'demo' : 'fastpath');

            document.getElementById('fastLabel').classList.toggle('active', !isDemoPath);
            document.getElementById('slowLabel').classList.toggle('active', isDemoPath);

            // Update all HTMX buttons to include policy header
            document.querySelectorAll('.test-btn[hx-get]').forEach(function(btn) {
                var headers = JSON.parse(btn.getAttribute('hx-headers') || '{}');
                // Use X-Bot-Policy header to select the policy
                headers['X-Bot-Policy'] = isDemoPath ? 'demo' : 'fastpath';
                btn.setAttribute('hx-headers', JSON.stringify(headers));
            });

            // Auto-refresh when toggling (but not on initial load)
            if (triggerRefresh) {
                var headers = {'X-Bot-Policy': isDemoPath ? 'demo' : 'fastpath'};
                htmx.ajax('GET', '/bot-test', {target: 'body', swap: 'outerHTML', headers: headers});
            }
        }

        // Initialize path toggle from localStorage
        (function initPathToggle() {
            var savedPath = localStorage.getItem('botDetectionPath');
            var toggle = document.getElementById('pathToggle');

            // Default to demo path if not set
            if (savedPath === 'fastpath') {
                toggle.checked = false;
            } else {
                toggle.checked = true;
            }

            // Initialize without triggering refresh
            togglePath(false);
        })();

        // Intercept fingerprint data
        (function() {
            var originalXHR = XMLHttpRequest.prototype.send;
            XMLHttpRequest.prototype.send = function(data) {
                if (this._url && this._url.includes('fingerprint')) {
                    try {
                        var parsed = JSON.parse(data);
                        renderHighlightedJson(document.getElementById('fingerprintData'), parsed);
                        updateClientUI(parsed);
                    } catch(e) {}
                }
                originalXHR.apply(this, arguments);
            };

            var originalOpen = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function(method, url) {
                this._url = url;
                originalOpen.apply(this, arguments);
            };
        })();

        function updateClientUI(data) {
            var score = data.score || 0;
            var badge = document.getElementById('clientBadge');
            var scoreEl = document.getElementById('clientScore');
            var details = document.getElementById('clientDetails');

            scoreEl.textContent = score + '/100';

            if (score >= 70) {
                badge.className = 'result-badge human';
                badge.textContent = 'Likely Human';
                scoreEl.className = 'confidence-score low';
            } else if (score >= 40) {
                badge.className = 'result-badge suspicious';
                badge.textContent = 'Suspicious';
                scoreEl.className = 'confidence-score medium';
            } else {
                badge.className = 'result-badge bot';
                badge.textContent = 'Likely Bot';
                scoreEl.className = 'confidence-score high';
            }

            var signals = [];
            if (data.webdriver) signals.push('WebDriver detected');
            if (data.phantom) signals.push('PhantomJS detected');
            if (data.selenium) signals.push('Selenium detected');
            if (data.cdc) signals.push('CDP markers detected');
            if (data.plugins === 0 && data.chrome) signals.push('Chrome with no plugins');
            if (data.outerW === 0) signals.push('Zero outer dimensions');

            details.innerHTML = signals.length ? signals.join(' | ') : 'No suspicious signals detected';
        }

        function fetchDetectionCheck() {
            // Get current policy from toggle
            var isDemoPath = document.getElementById('pathToggle').checked;
            var policy = isDemoPath ? 'demo' : 'fastpath';

            fetch('/bot-detection/check', {
                headers: { 'X-Bot-Policy': policy }
            })
                .then(r => r.json())
                .then(data => {
                    renderHighlightedJson(document.getElementById('apiResponse'), data);
                    // Update timing display from API response
                    if (data.processingTimeMs !== undefined) {
                        document.getElementById('timingDisplay').textContent = data.processingTimeMs.toFixed(2) + 'ms';
                    }
                })
                .catch(e => {
                    document.getElementById('apiResponse').innerHTML = '<span style="color: #da3633;">Error: ' + e.message + '</span>';
                });
        }

        // Auto-fetch on load
        setTimeout(fetchDetectionCheck, 500);
    </script>
</body>
</html>
